
infrastructures:
  management:
    type: rhev
    endpoint: https://rhev.example.com/api/
    credentials:
      username: myuser
      password: mypass
  lamp:
    type: openstack
    endpoint: https://openstack.example.com/api/
    credentials:
      username: myuser
      password: mypass
nodes:
  mysql01.example.com:
    cloud: lamp
    image: rhel6
    nets:
      int: dhcp
    flavor: medium
    disks:
      database: 30G

  web01.example.com:
    cloud: lamp
    image: rhel6
    nets:
      int: dhcp
    flavor: small

  web02.example.com:
    cloud: lamp
    image: rhel6
    nets:
      int: dhcp
    flavor: small

  haproxy01.example.com:
    cloud: lamp
    image: rhel6
    nets:
      int: dhcp
    flavor: small

  haproxy02.example.com:
    cloud: lamp
    image: rhel6
    nets:
      int: dhcp
    flavor: small

configuration:
  hosts:
    mysql01.example.com:
      my_role: mysql
    web01.example.com:
      my_role: httpd_basic
    web02.example.com:
      my_role: httpd_special
    haproxy01.example.com:
      my_role: haproxy
    haproxy02.example.com:
      my_role: haproxy
  roles:
    mysql:
      mysql::default_database:
        name: mydatabase
        user: myuser
        password: mypass

plan:
  max_in_flight: 2

steps:
  - name: 'Make sure we can login to all nodes'
    nodes: all
    command:
      plugin: ssh/wait_for_login
      plugin_timeout: 600

  - name: 'Install Puppet'
    nodes: all
    command:
      plugin: ssh/custom
      verify_commands:
        - plugin: ssh/file_exists
          file: /usr/bin/puppet
      exec: yum
      arguments: 'install puppet'
      expect_exit_codes: 0
      fail_on_warning: False
      parse_output:
        error:
          - '^No package puppet available'

  - name: 'Initial Puppet run to configure puppet'
    nodes: all
    command:
      plugin: ssh/puppet_agent_run
      verify_commands:
        - plugin: ssh/file_contains
          file: /etc/puppet/puppet.conf
          pattern: puppet.example.com
      arguments:
        - '--server puppet.example.com'
        - '--environment production'
        - '--tags puppet::client'

  - name: 'Configure the MySQL server'
    nodes:
      - mysql01.example.com
    command: ssh/puppet_agent_run

  - name: 'Configure the Webservers'
    roles:
      - httpd_basic
      - httpd_special
    command: ssh/puppet_agent_run

  - name: 'Configure the HA Proxy'
    roles:
      - haproxy
    command: ssh/puppet_agent_run
